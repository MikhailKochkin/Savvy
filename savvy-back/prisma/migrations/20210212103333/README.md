# Migration `20210212103333`

This migration has been generated by MikhailKochkin at 2/12/2021, 1:33:33 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "_SandboxToUser" DROP CONSTRAINT "_SandboxToUser_A_fkey"

ALTER TABLE "_SandboxToUser" DROP CONSTRAINT "_SandboxToUser_B_fkey"

ALTER TABLE "Sandbox" ADD COLUMN     "userId" TEXT

ALTER TABLE "User" DROP COLUMN "sandboxes"

CREATE TABLE "Chat" (
    "id" TEXT NOT NULL,
    "name" TEXT,
    "messages" JSONB,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "userId" TEXT NOT NULL,
    "lessonId" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

DROP TABLE "_SandboxToUser"

ALTER TABLE "Chat" ADD FOREIGN KEY("lessonId")REFERENCES "Lesson"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Chat" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Sandbox" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210112102848-errors-fix..20210212103333
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model Application {
   id            String     @id @default(cuid())
@@ -288,8 +288,9 @@
   quizResults        QuizResult[]
   shots              Shot[]
   shotResults        ShotResult[]
   test               Test[]
+  chats              Chat[]
   testResults        TestResult[]
   texteditors        TextEditor[]
   textEditorResults  TextEditorResult[]
 }
@@ -328,8 +329,9 @@
 model Note {
   id        String   @id @default(cuid())
   text      String
+  chat      Boolean?
   lessonID  String?  @default(cuid())
   updatedAt DateTime @updatedAt
   createdAt DateTime @default(now())
   next      Json?
@@ -546,9 +548,9 @@
   updatedAt  DateTime     @updatedAt
   createdAt  DateTime     @default(now())
   paidMonths Int?         @default(0)
   coursePage CoursePage[]
-  teachers       User[]
+  teachers   User[]
 }
 model User {
   id                           String               @id @default(cuid())
@@ -567,9 +569,8 @@
   resume                       String?
   coverLetter                  String?
   surname                      String?
   image                        String?
-  sandboxes                    String[]
   favourites                   String[]
   subjects                     String[]
   interests                    String[]
   permissions                  Permission[]
@@ -582,11 +583,11 @@
   company                      Company?             @relation(fields: [companyId], references: [id])
   legalPortfolio               LegalPortfolio?      @relation(fields: [legalPortfolioId], references: [id])
   level                        UserLevel?           @relation(fields: [levelId], references: [id])
   uni                          Uni?                 @relation(fields: [uniId], references: [id])
-  challengeResults              ChallengeResult[]
-  clauses                       Clause[]
-  constructions                 Construction[]
+  challengeResults             ChallengeResult[]
+  clauses                      Clause[]
+  constructions                Construction[]
   constructionResults           ConstructionResult[]
   coursePages                   CoursePage[]
   courseVisits                  CourseVisit[]
   documents                     Document[]
@@ -614,8 +615,9 @@
   sandboxPageGoals              SandboxPageGoal[]
   shots                         Shot[]
   shotResults                   ShotResult[]
   statements                    Statement[]
+  chats                         Chat[]
   tests                         Test[]
   testResults                  TestResult[]
   textEditors                   TextEditor[]
   textEditorResults            TextEditorResult[]
@@ -682,8 +684,20 @@
   lesson    Lesson?  @relation(fields: [lessonId], references: [id])
   user      User?    @relation(fields: [userId], references: [id])
 }
+model Chat {
+  id           String       @id @default(cuid())
+  name         String?
+  messages     Json?
+  updatedAt    DateTime
+  createdAt    DateTime     @default(now())
+  userId       String
+  lessonId     String
+  lesson       Lesson   @relation(fields: [lessonId], references: [id])
+  user         User     @relation(fields: [userId], references: [id])
+}
+
 model PointA {
   id           String       @id
   description  String?
   updatedAt    DateTime
@@ -727,9 +741,8 @@
   likes         Int?        @default(0)
   link          String?
   sandboxPageId String
   sandboxPage   SandboxPage @relation(fields: [sandboxPageId], references: [id])
-  user          User[]
 }
 model SandboxPage {
   id              String            @id
```


