# Migration `20221129112822-teams`

This migration has been generated by MikhailKochkin at 11/29/2022, 3:28:22 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "Order" ADD COLUMN     "teamId" TEXT

ALTER TABLE "User" ADD COLUMN     "teamId" TEXT

CREATE TABLE "TeamQuest" (
    "id" TEXT NOT NULL,
    "introduction" TEXT NOT NULL,
    "solution" TEXT,
    "tasks" JSONB NOT NULL,
    "userId" TEXT NOT NULL,
    "lessonId" TEXT NOT NULL,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY ("id")
)

CREATE TABLE "TeamQuestResult" (
    "id" TEXT NOT NULL,
    "answer" TEXT,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "studentId" TEXT NOT NULL,
    "lessonId" TEXT,
    "teamQuestId" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "Team" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "image" TEXT,

    PRIMARY KEY ("id")
)

ALTER TABLE "TeamQuest" ADD FOREIGN KEY("lessonId")REFERENCES "Lesson"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "TeamQuest" ADD FOREIGN KEY("userId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "TeamQuestResult" ADD FOREIGN KEY("lessonId")REFERENCES "Lesson"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "TeamQuestResult" ADD FOREIGN KEY("teamQuestId")REFERENCES "TeamQuest"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "TeamQuestResult" ADD FOREIGN KEY("studentId")REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "Order" ADD FOREIGN KEY("teamId")REFERENCES "Team"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "User" ADD FOREIGN KEY("teamId")REFERENCES "Team"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20221115123933-traffic..20221129112822-teams
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model Application {
   id            String     @id @default(cuid())
@@ -405,8 +405,10 @@
   test                Test[]
   testResults         TestResult[]
   texteditors         TextEditor[]
   textEditorResults   TextEditorResult[]
+  teamQuests          TeamQuest[]
+  teamQuestResults    TeamQuestResult[]
 }
 model LessonResult {
   id           String   @id @default(cuid())
@@ -502,13 +504,15 @@
   isPaid       Boolean?
   level        Level?
   comment      String?
   userId       String
+  teamId       String?
   coursePageId String
   programId    String?
   program      Program?  @relation(fields: [programId], references: [id])
   coursePage   CoursePage @relation(fields: [coursePageId], references: [id])
   user         User       @relation(fields: [userId], references: [id])
+  team         Team?       @relation(fields: [teamId], references: [id])
 }
 model Post {
   id          String       @id @default(cuid())
@@ -526,8 +530,35 @@
   user        User         @relation(fields: [userId], references: [id])
   coursePage CoursePage?   @relation(fields: [coursePageId], references: [id])
 }
+model TeamQuest {
+  id                String          @id @default(cuid())
+  introduction      String
+  solution          String?
+  tasks             Json
+  userId            String
+  lessonId          String
+  updatedAt         DateTime @updatedAt
+  createdAt         DateTime @default(now())
+  lesson            Lesson          @relation(fields: [lessonId], references: [id])
+  user              User            @relation(fields: [userId], references: [id])
+  teamQuestResults  TeamQuestResult[]
+}
+
+model TeamQuestResult {
+  id            String   @id @default(cuid())
+  answer        String?
+  updatedAt     DateTime @updatedAt
+  createdAt     DateTime @default(now())
+  studentId     String
+  lessonId      String?
+  teamQuestId   String?
+  lesson        Lesson?  @relation(fields: [lessonId], references: [id])
+  teamQuest     TeamQuest? @relation(fields: [teamQuestId], references: [id])
+  student       User     @relation(fields: [studentId], references: [id])
+}
+
 model Problem {
   id             String          @id @default(cuid())
   text           String
   hints          String?
@@ -718,8 +749,16 @@
   coursePage CoursePage[]
   teachers   User[]
 }
+model Team {
+  id                  String               @id @default(cuid())
+  name                String
+  image               String?
+  orders              Order[]
+  users               User[]
+}
+
 model User {
   id                  String               @id @default(cuid())
   name                String
   number              String?
@@ -748,8 +787,10 @@
   tags                String[]
   permissions         Permission[]
   uniId               String?
   companyId           String?
+  teamId              String?
+  team                Team?                @relation(fields: [teamId], references: [id])
   legalPortfolioId    String?              @unique
   careerTrackId       String?              @unique
   levelId             String?              @unique
   careerTrack         CareerTrack?         @relation(fields: [careerTrackId], references: [id])
@@ -798,8 +839,10 @@
   testResults         TestResult[]
   textEditors         TextEditor[]
   textEditorResults   TextEditorResult[]
   lawrdles            Lawrdle[]
+  teamQuests          TeamQuest[]
+  teamQuestResults    TeamQuestResult[]
   co_coursePages      CoursePage[]         @relation("AuthorsCoursePage")
   new_subjects        CoursePage[]         @relation("UserSubjects")
 }
```


